<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ˜å°„èˆ‡å…¨åå°„å¯¦é©—</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #000; color: #eee; margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            overscroll-behavior: none;
        }
        
        .nav { width: 100%; margin-bottom: 10px; }
        .nav a { color: #00d4ff; text-decoration: none; font-size: 14px; }

        .controls-container {
            width: 100%; max-width: 600px;
            background: #1a1a1a; padding: 15px 20px; border-radius: 12px;
            margin-bottom: 15px; box-sizing: border-box; border: 1px solid #333;
        }
        .slider-group { margin-bottom: 15px; }
        .slider-group:last-child { margin-bottom: 0; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; color: #ccc; }
        .slider-label b { color: #00d4ff; font-family: monospace; font-size: 1.1em; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #00d4ff; cursor: pointer; margin-top: -7px; box-shadow: 0 0 8px rgba(0,212,255,0.6);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px;
        }

        #canvas-container { 
            width: 100%; max-width: 600px; 
            display: flex; justify-content: center; margin-bottom: 15px;
            position: relative;
        }
        canvas { border-radius: 4px; border: 1px solid #333; cursor: crosshair; }

        .dashboard {
            width: 100%; max-width: 600px;
            background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333;
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .data-box { text-align: center; }
        .data-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .data-value { font-size: 20px; font-weight: bold; color: #fff; }
        
        .warn-box {
            grid-column: span 2;
            background: #330000; border: 1px solid #ff4444; color: #ffaaaa;
            padding: 8px; border-radius: 6px; text-align: center; font-size: 14px;
            display: none; 
        }
        .info-text { font-size: 12px; color: #666; margin-top: 10px; text-align: center;}
    </style>
</head>
<body>
    <div class="nav"><a href="../index.html">â† è¿”å›é¦–é </a></div>

    <div class="controls-container">
        <div class="slider-group">
            <div class="slider-label">å…¥å°„è§’ (Î¸â‚) <b id="val_theta1">45Â°</b></div>
            <input type="range" id="sl_angle" min="0" max="85" value="45">
        </div>
        <div class="slider-group">
            <div class="slider-label">ä¸Šå±¤æŠ˜å°„ç‡ nâ‚ <b id="val_n1">1.50</b></div>
            <input type="range" id="sl_n1" min="1.00" max="2.50" value="1.50" step="0.01">
        </div>
        <div class="slider-group">
            <div class="slider-label">ä¸‹å±¤æŠ˜å°„ç‡ nâ‚‚ <b id="val_n2">1.00</b></div>
            <input type="range" id="sl_n2" min="1.00" max="2.50" value="1.00" step="0.01">
        </div>
    </div>

    <div id="canvas-container"></div>

    <div class="dashboard">
        <div class="warn-box" id="tir_msg">âš ï¸ ç™¼ç”Ÿå…¨åå°„ (Total Internal Reflection)</div>
        
        <div class="data-box">
            <div class="data-label">æŠ˜å°„è§’ (Î¸â‚‚)</div>
            <div class="data-value" id="val_theta2">--</div>
        </div>
        <div class="data-box">
            <div class="data-label">è‡¨ç•Œè§’ (Î¸c)</div>
            <div class="data-value" id="val_critical">41.8Â°</div>
        </div>
    </div>
    <div class="info-text">ğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥ç”¨æ‰‹æŒ‡æ‹–å‹•é›·å°„ç­†æ”¹è®Šè§’åº¦</div>

    <script>
        let sl_angle, sl_n1, sl_n2;
        let canvasW, canvasH;
        let isDragging = false;

        function setup() {
            canvasW = min(windowWidth - 20, 600);
            canvasH = 350;
            let cnv = createCanvas(canvasW, canvasH);
            cnv.parent('canvas-container');
            
            sl_angle = select('#sl_angle');
            sl_n1 = select('#sl_n1');
            sl_n2 = select('#sl_n2');
            
            cnv.mousePressed(startDrag);
            cnv.mouseReleased(endDrag);
            cnv.touchStarted(startDrag);
            cnv.touchEnded(endDrag);
            
            textAlign(CENTER, CENTER);
        }

        function draw() {
            background(10);
            
            let theta1_deg = float(sl_angle.value());
            let n1 = float(sl_n1.value());
            let n2 = float(sl_n2.value());
            
            if (isDragging) {
                let dx = mouseX - width/2;
                let dy = mouseY - height/2;
                if (mouseY < height/2) {
                    let angleRad = atan2(dx, -dy); 
                    theta1_deg = degrees(angleRad);
                    if (theta1_deg < -85) theta1_deg = -85;
                    if (theta1_deg > 85) theta1_deg = 85;
                    sl_angle.value(abs(theta1_deg));
                }
            }

            // è½‰ç‚ºå¼§åº¦é‹ç®—
            let theta1 = radians(theta1_deg); // é€™æ˜¯å¸¶æœ‰æ­£è² è™Ÿçš„å¼§åº¦
            let absTheta1 = abs(theta1);      // çµ•å°å€¼ç”¨æ–¼æ–¯ä¹ƒè€³å®šå¾‹è¨ˆç®—
            
            let sin_t2 = (n1 / n2) * sin(absTheta1);
            let theta2 = 0;
            let isTIR = false; 

            if (abs(sin_t2) > 1.0) {
                isTIR = true; 
            } else {
                theta2 = asin(sin_t2);
            }

            let critical_angle_deg = "ç„¡";
            if (n1 > n2) {
                critical_angle_deg = degrees(asin(n2/n1)).toFixed(1) + "Â°";
            }

            // UI Update
            select('#val_theta1').html(abs(theta1_deg).toFixed(1) + "Â°");
            select('#val_n1').html(n1.toFixed(2));
            select('#val_n2').html(n2.toFixed(2));
            select('#val_critical').html(critical_angle_deg);

            let t2_display = select('#val_theta2');
            let tir_box = select('#tir_msg');
            
            if (isTIR) {
                t2_display.html("--");
                tir_box.style('display', 'block');
            } else {
                t2_display.html(degrees(abs(theta2)).toFixed(1) + "Â°");
                tir_box.style('display', 'none');
            }

            // --- ç¹ªåœ– ---
            translate(width/2, height/2); 

            // 1. ä»‹è³ªèƒŒæ™¯
            noStroke();
            fill(30, 30, 30 + n1*30); 
            rect(-width/2, -height/2, width, height/2);
            fill(30, 30, 30 + n2*30);
            rect(-width/2, 0, width, height/2);

            // 2. æ³•ç·šèˆ‡ä»‹é¢
            stroke(100); strokeWeight(1);
            line(-width/2, 0, width/2, 0); 
            drawingContext.setLineDash([5, 5]); 
            line(0, -height/2, 0, height/2); 
            drawingContext.setLineDash([]); 

            noStroke(); fill(150); textSize(12);
            text(`nâ‚ = ${n1}`, -width/2 + 30, -20);
            text(`nâ‚‚ = ${n2}`, -width/2 + 30, 30);

            // 3. è§’åº¦æ¨™ç¤º (å¼§ç·šèˆ‡æ–‡å­—)
            // Î¸1: å…¥å°„è§’
            if (absTheta1 > 0.1) {
                noFill(); stroke(255, 200, 0, 150); strokeWeight(2);
                // arc(x, y, w, h, start, stop)
                // å¾ -90åº¦ (æ³•ç·šé ‚ç«¯) é–‹å§‹ï¼Œç•«åˆ°å…¥å°„ç·šè§’åº¦
                // theta1 æ˜¯ç›¸å°æ–¼æ³•ç·šçš„è§’åº¦ï¼Œä½† arc æ˜¯å¾ X è»¸æ­£å‘ç®—èµ·
                // æ³•ç·šæ–¹å‘æ˜¯ -PI/2
                // å…¥å°„å…‰ä¾†æºè§’åº¦æ˜¯ -PI/2 - theta1
                
                // ç‚ºäº†ç•«åœ¨æ³•ç·šèˆ‡å…‰ç·šä¹‹é–“ï¼š
                let startAng = -HALF_PI; 
                let endAng = -HALF_PI - theta1;
                
                // ç¢ºä¿ start < end ä»¥åˆ©ç¹ªè£½ï¼Œæˆ–äº¤æ›
                if (theta1 > 0) { // å…‰åœ¨å·¦é‚Š
                    arc(0, 0, 80, 80, endAng, startAng);
                } else { // å…‰åœ¨å³é‚Š
                    arc(0, 0, 80, 80, startAng, endAng);
                }
                
                // æ¨™ç¤ºæ–‡å­— Î¸1
                fill(255, 200, 0); noStroke(); textSize(14);
                let textAng = -HALF_PI - theta1 / 2;
                let tx = cos(textAng) * 55;
                let ty = sin(textAng) * 55;
                text("Î¸â‚", tx, ty);
            }

            // Î¸2: æŠ˜å°„è§’ (åªæœ‰åœ¨éå…¨åå°„æ™‚é¡¯ç¤º)
            if (!isTIR && abs(theta2) > 0.1) {
                // theta2 æ˜¯çµ•å°å€¼ï¼Œæˆ‘å€‘éœ€è¦æ ¹æ“šå…¥å°„å…‰æ–¹å‘æ±ºå®šæŠ˜å°„å…‰æ–¹å‘
                // å¦‚æœå…¥å°„å…‰åœ¨å·¦(theta1 > 0)ï¼ŒæŠ˜å°„å…‰å°±åœ¨å³ï¼Œåä¹‹äº¦ç„¶
                // é€™è£¡çš„ theta2 è¨ˆç®—å‡ºä¾†æ˜¯æ­£å€¼(asinçµæœ)ï¼Œéœ€è¦åŠ ä¸Šæ­£è² è™Ÿ
                let sign = (theta1 >= 0) ? 1 : -1; 
                let realTheta2 = sign * theta2; // ç›¸å°æ–¼æ³•ç·š(ä¸‹æ–¹)çš„å¤¾è§’
                
                noFill(); stroke(0, 255, 255, 150); strokeWeight(2);
                
                // æ³•ç·šä¸‹æ–¹æ˜¯ HALF_PI
                // æŠ˜å°„å…‰è§’åº¦æ˜¯ HALF_PI - realTheta2 (å› ç‚ºå…‰ç·šæ˜¯å¾€å°å´)
                // ä¿®æ­£ï¼šæŠ˜å°„å…‰ç·šæ‡‰è©²åœ¨å…¥å°„å…‰çš„å°å´
                // å¦‚æœå…¥å°„å…‰å¾å·¦ä¸Š(-x)ä¾†ï¼Œtheta1>0ï¼ŒæŠ˜å°„å…‰å»å³ä¸‹(+x)ï¼Œèˆ‡æ³•ç·š(+y)å¤¾è§’ theta2
                
                let normalDown = HALF_PI;
                // å…‰ç·šè§’åº¦: normalDown + sign * theta2 ? 
                // è®“æˆ‘å€‘çœ‹å¹¾ä½•ï¼šå…¥(å·¦ä¸Š) -> æŠ˜(å³ä¸‹)ã€‚å…¥å°„è§’èˆ‡æ³•ç·šå¤¾è§’ã€‚æŠ˜å°„è§’èˆ‡æ³•ç·šå¤¾è§’ã€‚
                // ç¹ªè£½å¾æ³•ç·šåˆ°æŠ˜å°„å…‰
                
                // å³ä¸‹ï¼šæ³•ç·šæ˜¯ 90åº¦ã€‚å…‰ç·šæ˜¯ 90 - theta2
                // å·¦ä¸‹ï¼šæ³•ç·šæ˜¯ 90åº¦ã€‚å…‰ç·šæ˜¯ 90 + theta2
                
                let targetAng = normalDown + (theta1 > 0 ? -theta2 : theta2);
                
                if (theta1 > 0) { // å…‰å¾€å³ä¸‹æŠ˜
                    arc(0, 0, 80, 80, targetAng, normalDown);
                } else { // å…‰å¾€å·¦ä¸‹æŠ˜
                    arc(0, 0, 80, 80, normalDown, targetAng);
                }
                
                // æ¨™ç¤ºæ–‡å­— Î¸2
                fill(0, 255, 255); noStroke();
                let textAng2 = normalDown + (theta1 > 0 ? -theta2/2 : theta2/2);
                let tx2 = cos(textAng2) * 55;
                let ty2 = sin(textAng2) * 55;
                text("Î¸â‚‚", tx2, ty2);
            }

            // --- å…‰ç·šç¹ªè£½ ---
            let laserColor = color(255, 50, 50); 
            
            // èµ·é»
            let originX = -sin(theta1) * 200;
            let originY = -cos(theta1) * 200;
            
            // å…¥å°„å…‰
            drawRay(originX, originY, 0, 0, laserColor, 3);
            
            // é›·å°„ç­† (å¹³è¡Œå…‰ç·š)
            push();
            translate(originX, originY);
            let beamAngle = atan2(0 - originY, 0 - originX);
            rotate(beamAngle); 
            noStroke();
            fill(120); rect(-50, -10, 50, 20, 4); 
            fill(50); rect(-35, -12, 10, 3);
            fill(255, 50, 50); rect(-2, -5, 2, 10);
            pop();

            // åå°„å…‰
            let rX = sin(theta1) * 200;
            let rY = -cos(theta1) * 200;
            let reflectAlpha = isTIR ? 255 : 100;
            drawRay(0, 0, rX, rY, color(255, 50, 50, reflectAlpha), 2);

            // æŠ˜å°„å…‰
            if (!isTIR) {
                // å¦‚æœ theta1 > 0 (å·¦ä¸Š)ï¼ŒæŠ˜å°„å…‰åœ¨ (å³ä¸‹) -> xæ­£, yæ­£
                // sin(theta2) æ˜¯æ­£å€¼ã€‚
                // x = sin(theta2)*200, y = cos(theta2)*200
                // ä½†è¦è€ƒæ…®å…¥å°„å…‰æ–¹å‘ã€‚
                // å¦‚æœ theta1 æ˜¯æ­£çš„(æ»‘é¼ åœ¨å·¦)ï¼Œå…‰å¾å·¦ä¸Šä¾†ï¼Œè¦æŠ˜å°„åˆ°å³ä¸‹ã€‚
                // æˆ‘å€‘ä¸Šé¢çš„ theta1 è®Šæ•¸æ˜¯æœ‰è™Ÿçš„ã€‚
                // æ ¹æ“šå¹¾ä½•ï¼ŒæŠ˜å°„å…‰ x åˆ†é‡ç¬¦è™Ÿæ‡‰è©²èˆ‡å…¥å°„å…‰ä¾†æº x åˆ†é‡ç¬¦è™Ÿç›¸å (-originX æ˜¯æ­£çš„)
                // ç°¡å–®ä½œæ³•ï¼šåˆ©ç”¨ theta2 å¤§å°ï¼Œé…åˆ theta1 çš„ç¬¦è™Ÿ
                
                let sign = (theta1 >= 0) ? 1 : -1;
                let tX = sign * sin(theta2) * 200;
                let tY = cos(theta2) * 200; // æ°¸é å¾€ä¸‹
                
                drawRay(0, 0, tX, tY, color(255, 100, 100), 3);
            }
            
            fill(255); noStroke();
            ellipse(0, 0, 4, 4);
        }

        function drawRay(x1, y1, x2, y2, c, w) {
            stroke(c); strokeWeight(w); line(x1, y1, x2, y2);
            strokeWeight(w + 6); stroke(red(c), green(c), blue(c), 40); line(x1, y1, x2, y2);
        }
        
        function startDrag() { return false; } // ç¦æ­¢åç™½
        function endDrag() { isDragging = false; }
        
        function windowResized() {
            canvasW = min(windowWidth - 20, 600);
            resizeCanvas(canvasW, 350);
        }
    </script>
</body>
</html>
